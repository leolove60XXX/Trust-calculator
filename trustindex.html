<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣他益信託節稅試算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        /* Loading animation */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">他益信託贈與稅試算器</h1>
            <p class="text-slate-600">利用「折現值」原理，預估資產傳承的節稅效益</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Left: Inputs -->
            <div class="md:col-span-1 space-y-6">
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-700 mb-4 border-b pb-2">設定參數</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">信託總金額 (TWD)</label>
                            <input type="number" id="principal" value="10000000" step="1000000" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <p class="text-xs text-slate-400 mt-1">欲傳承給受益人的本金</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">信託期間 (年)</label>
                            <input type="range" id="years" min="1" max="50" value="10" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-slate-600 mt-1">
                                <span>1年</span>
                                <span class="font-bold text-blue-600" id="yearsVal">10年</span>
                                <span>50年</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">折現利率 (%)</label>
                            <input type="number" id="rate" value="1.725" step="0.005" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <p class="text-xs text-slate-400 mt-1">參考郵政儲金一年期固定利率</p>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                    <p class="text-sm text-blue-700 font-medium">公式基礎：</p>
                    <p class="text-xs text-blue-600 mt-1">贈與價值 = 信託金額 / (1 + 利率)^年限</p>
                </div>

                <!-- AI Consultant Trigger -->
                <button id="aiConsultantBtn" class="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                    <span>✨ AI 稅務策略分析</span>
                    <div id="aiLoader" class="spinner hidden"></div>
                </button>
            </div>

            <!-- Right: Results -->
            <div class="md:col-span-2 space-y-6">
                <!-- Main KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="card p-6 border-t-4 border-slate-400">
                        <p class="text-sm text-slate-500 uppercase font-bold">一般直接贈與稅基</p>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="directBase">NT$ 10,000,000</p>
                    </div>
                    <div class="card p-6 border-t-4 border-blue-500">
                        <p class="text-sm text-blue-500 uppercase font-bold">信託折現後稅基</p>
                        <p class="text-2xl font-bold text-blue-600 mt-1" id="trustBase">NT$ 8,426,512</p>
                    </div>
                </div>

                <!-- Savings Highlight -->
                <div class="gradient-bg rounded-2xl p-8 text-white">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <p class="text-slate-300 text-sm">透過信託規劃「消失」的稅基</p>
                            <p class="text-4xl font-bold mt-1" id="baseSavings">NT$ 1,573,488</p>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                            <p class="text-xs text-slate-200">估計節省贈與稅額</p>
                            <p class="text-2xl font-bold text-green-400" id="taxSavings">NT$ 157,349</p>
                        </div>
                    </div>
                </div>

                <!-- Detailed Comparison Table -->
                <div class="card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4 text-sm font-bold text-slate-600">項目</th>
                                <th class="px-6 py-4 text-sm font-bold text-slate-600">一般贈與</th>
                                <th class="px-6 py-4 text-sm font-bold text-blue-600">他益信託 (本金受益)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y text-sm">
                            <tr>
                                <td class="px-6 py-4 font-medium">申報贈與總額</td>
                                <td class="px-6 py-4" id="tableDirectTotal">10,000,000</td>
                                <td class="px-6 py-4 text-blue-600 font-bold" id="tableTrustTotal">8,426,512</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium">免稅額 (每人每年)</td>
                                <td class="px-6 py-4">2,440,000</td>
                                <td class="px-6 py-4">2,440,000</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 font-medium">課稅贈與淨額</td>
                                <td class="px-6 py-4" id="tableDirectNet">7,560,000</td>
                                <td class="px-6 py-4" id="tableTrustNet">5,986,512</td>
                            </tr>
                            <tr class="bg-slate-50 font-bold">
                                <td class="px-6 py-4">預估應納贈與稅</td>
                                <td class="px-6 py-4 text-red-500" id="tableDirectTax">756,000</td>
                                <td class="px-6 py-4 text-blue-600" id="tableTrustTax">598,651</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- AI Response Section -->
                <div id="aiSection" class="hidden card p-6 border-t-4 border-indigo-500 bg-indigo-50/30">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-xl">✨</span>
                        <h3 class="text-lg font-bold text-indigo-900">AI 專家分析建議</h3>
                    </div>
                    <div id="aiOutput" class="text-slate-700 text-sm leading-relaxed space-y-4">
                        <!-- AI content will appear here -->
                    </div>
                </div>

                <footer class="text-center text-xs text-slate-400 py-4">
                    註：以上計算結果僅供參考。實際課稅時點、稅基認定及適用稅率應依主管機關核定為準。<br>
                    贈與稅率採三級累進：2500萬以下10%、2500-5000萬15%、5000萬以上20%。
                </footer>
            </div>
        </div>
    </div>

    <!-- Error Message Box (Custom UI instead of alert) -->
    <div id="errorBox" class="fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-2xl hidden z-50">
        <p id="errorText"></p>
    </div>

    <script>
        const apiKey = ""; // 執行環境會自動填入
        const inputs = ['principal', 'years', 'rate'];
        
        function formatCurrency(val) {
            return 'NT$ ' + Math.round(val).toLocaleString();
        }

        function calculateGiftTax(netAmount) {
            if (netAmount <= 0) return 0;
            if (netAmount <= 25000000) {
                return netAmount * 0.10;
            } else if (netAmount <= 50000000) {
                return (netAmount * 0.15) - 1250000;
            } else {
                return (netAmount * 0.20) - 3750000;
            }
        }

        let currentData = {};

        function update() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const years = parseInt(document.getElementById('years').value);
            const rate = parseFloat(document.getElementById('rate').value) / 100;
            const exempt = 2440000;

            document.getElementById('yearsVal').innerText = years + '年';

            const directTaxBase = principal;
            const directNet = Math.max(0, directTaxBase - exempt);
            const directTax = calculateGiftTax(directNet);

            const trustTaxBase = principal / Math.pow((1 + rate), years);
            const trustNet = Math.max(0, trustTaxBase - exempt);
            const trustTax = calculateGiftTax(trustNet);

            currentData = {
                principal,
                years,
                ratePercent: (rate * 100).toFixed(3),
                directTaxBase,
                trustTaxBase: Math.round(trustTaxBase),
                baseSavings: Math.round(directTaxBase - trustTaxBase),
                taxSavings: Math.round(directTax - trustTax)
            };

            document.getElementById('directBase').innerText = formatCurrency(directTaxBase);
            document.getElementById('trustBase').innerText = formatCurrency(trustTaxBase);
            document.getElementById('baseSavings').innerText = formatCurrency(currentData.baseSavings);
            document.getElementById('taxSavings').innerText = formatCurrency(currentData.taxSavings);

            document.getElementById('tableDirectTotal').innerText = directTaxBase.toLocaleString();
            document.getElementById('tableTrustTotal').innerText = Math.round(trustTaxBase).toLocaleString();
            document.getElementById('tableDirectNet').innerText = directNet.toLocaleString();
            document.getElementById('tableTrustNet').innerText = Math.round(trustNet).toLocaleString();
            document.getElementById('tableDirectTax').innerText = Math.round(directTax).toLocaleString();
            document.getElementById('tableTrustTax').innerText = Math.round(trustTax).toLocaleString();
        }

        async function callGemini() {
            const btn = document.getElementById('aiConsultantBtn');
            const loader = document.getElementById('aiLoader');
            const aiSection = document.getElementById('aiSection');
            const aiOutput = document.getElementById('aiOutput');
            const errorBox = document.getElementById('errorBox');
            
            btn.disabled = true;
            loader.classList.remove('hidden');
            aiSection.classList.remove('hidden');
            aiOutput.innerHTML = "正在調研稅務策略中...";

            const prompt = `請以專業家族信託規劃師與稅務顧問的角度，分析以下台灣他益信託試算數據：
            - 原始本金: NT$ ${currentData.principal.toLocaleString()}
            - 信託年限: ${currentData.years}年
            - 預計利率: ${currentData.ratePercent}%
            - 信託折現後稅基: NT$ ${currentData.trustTaxBase.toLocaleString()}
            - 節省稅基金額: NT$ ${currentData.baseSavings.toLocaleString()}
            - 估計省下稅額: NT$ ${currentData.taxSavings.toLocaleString()}

            請提供：
            1. 為什麼這個規劃方案能達成節稅效果的直白解釋？
            2. 給委託人的 3 個專業建議（例如分年多次設立、搭配孳息他益、或考慮贈與免稅額利用）。
            3. 風險提醒（如委託人保留控制權導致的課稅時點改變風險）。
            請使用繁體中文，格式清晰，使用 Markdown 列表。`;

            const systemPrompt = "你是一位精通台灣信託法、遺贈稅法及家族辦公室財富傳承策略的頂級顧問。請以專業且易懂的語氣回答用戶，確保回答內容符合台灣法律邏輯。";

            const fetchAI = async (retryCount = 0) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) throw new Error('API Request Failed');
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error('No response text');
                    
                    // Simple Markdown-like formatting
                    aiOutput.innerHTML = text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/^- (.*)/gm, '• $1');
                        
                } catch (error) {
                    if (retryCount < 5) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        setTimeout(() => fetchAI(retryCount + 1), delay);
                    } else {
                        errorBox.classList.remove('hidden');
                        document.getElementById('errorText').innerText = "連線失敗，請檢查網路或稍後再試。";
                        setTimeout(() => errorBox.classList.add('hidden'), 5000);
                        aiOutput.innerHTML = "抱歉，目前無法取得 AI 分析結果。";
                    }
                } finally {
                    btn.disabled = false;
                    loader.classList.add('hidden');
                }
            };

            fetchAI();
        }

        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', update);
        });
        
        document.getElementById('aiConsultantBtn').addEventListener('click', callGemini);

        update();
    </script>
</body>
</html>